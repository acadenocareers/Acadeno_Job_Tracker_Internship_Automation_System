name: Kerala IT Park Job Scraper Automation

on:
  schedule:
    - cron: '30 2,15 * * *'   # 8:00 AM & 9:00 PM IST
    - cron: '50 10 * * *'     # 4:20 PM IST
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # allows uploading PDF back to repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests beautifulsoup4 reportlab webdriver-manager

      - name: Run Maitexa job scraper
        run: python app.py

      # ðŸŸ¢ Upload PDF to repository (so it has a public link)
      - name: Commit and push PDF to repo
        run: |
          mkdir -p pdf_reports
          mv Maitexa_Green_Adjusted_Brochure.pdf pdf_reports/
          git config --global user.name "Maitexa Auto Bot"
          git config --global user.email "noreply@maitexa.com"
          git add pdf_reports/Maitexa_Green_Adjusted_Brochure.pdf
          git commit -m "Auto update Maitexa job brochure PDF"
          git push

      - name: Send professional email with PDF link
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python - <<'EOF'
          import os, time, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          recipients = [x.strip() for x in os.getenv("EMAIL_TO", "").split(",") if x.strip()]
          repo = os.getenv("GITHUB_REPOSITORY")

          # Generate public GitHub URL to open PDF
          pdf_url = f"https://github.com/{repo}/raw/main/pdf_reports/Maitexa_Green_Adjusted_Brochure.pdf"

          msg = MIMEMultipart("alternative")
          msg["From"] = f"Maitexa Technologies <{sender}>"
          msg["To"] = ", ".join(recipients)
          msg["Subject"] = f"ðŸŒŸ Exciting Career Opportunities Await You â€“ {datetime.now().strftime('%d %b %Y')}"

          # Updated HTML email (opens PDF directly)
          html_content = f"""
          <html>
          <body style="font-family: Arial, sans-serif; font-size:15px; color:#222; line-height:1.6;">
              <p>Dear Team,</p>

              <p>We are thrilled to inform you that <strong>new and exciting career opportunities</strong> 
              are now open for talented individuals like you.</p>

              <p>At <strong>Maitexa Technologies</strong>, we believe that dreams are the starting point of every great success story. 
              This is your chance to chase your dreams and build a rewarding career with us.</p>

              <p>âœ¨ <strong>Explore the latest openings</strong> and find the role that best fits your passion and skills.</p>

              <p style="margin-top: 10px; text-align: center;">
                  <a href="{pdf_url}" target="_blank"
                     style="background-color:#007A33; color:#fff; padding:10px 20px; text-decoration:none; 
                     border-radius:5px; font-weight:bold;">
                     ðŸ‘‰ Click here to view current openings
                  </a>
              </p>

              <p>Take a moment to look through the opportunities and apply for the position that aligns with your goals.<br>
              Your next big move could start today!</p>

              <p>We wish you all the best in your career journey. Letâ€™s build a brighter future together!</p>

              <p style="margin-top:20px;">Warm regards,<br>
              <strong style="color:#007A33;">Maitexa Technologies Pvt Ltd</strong><br>
              Kadannamanna, Malappuram, Kerala â€“ 679324<br>
              <a href='mailto:contact@maitexa.com'>contact@maitexa.com</a> |
              <a href='https://www.maitexa.com'>www.maitexa.com</a></p>

              <p style="font-size:12px; color:#666;">â€” Generated automatically by Maitexa Job Tracker Â© 2025</p>
          </body>
          </html>
          """

          msg.attach(MIMEText(html_content, "html"))

          with smtplib.SMTP("smtp.gmail.com", 587) as server:
              server.starttls()
              server.login(sender, password)
              server.send_message(msg)

          print(f"âœ… Email sent successfully with live PDF link: {pdf_url}")
          EOF
