name: Kerala IT Park Job Scraper Automation

on:
  schedule:
    - cron: '30 2,15 * * *'   # 8:00 AM & 9:00 PM IST
    - cron: '50 10 * * *'     # 4:20 PM IST
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests beautifulsoup4 reportlab webdriver-manager

      - name: Run Maitexa job scraper
        run: |
          echo "üöÄ Running Maitexa scraper..."
          python app.py || echo "‚ö†Ô∏è Scraper ran with warnings."

          echo "üìÅ Checking for generated PDF..."
          if [ ! -f "Maitexa_Green_Adjusted_Brochure.pdf" ]; then
            echo "‚ùå PDF not found. Creating a fallback PDF..."
            python - <<'EOF'
            from reportlab.pdfgen import canvas
            from reportlab.lib.pagesizes import A4
            pdf = canvas.Canvas("Maitexa_Green_Adjusted_Brochure.pdf", pagesize=A4)
            pdf.setFont("Helvetica-Bold", 16)
            pdf.drawCentredString(300, 780, "Maitexa Technologies Pvt Ltd")
            pdf.setFont("Helvetica", 12)
            pdf.drawCentredString(300, 740, "No new job updates found at this moment.")
            pdf.drawCentredString(300, 720, "Please check back later for fresh openings.")
            pdf.save()
            EOF
          else
            echo "‚úÖ PDF generated successfully."
          fi

      - name: Upload PDF to transfer.sh
        id: upload
        run: |
          echo "üåç Uploading PDF to transfer.sh..."
          if [ ! -f "Maitexa_Green_Adjusted_Brochure.pdf" ]; then
            echo "‚ùå PDF file missing after fallback. Aborting."
            exit 1
          fi

          url=$(curl -s --upload-file Maitexa_Green_Adjusted_Brochure.pdf https://transfer.sh/Maitexa_Green_Adjusted_Brochure.pdf || true)
          if echo "$url" | grep -q "https://"; then
            echo "‚úÖ Uploaded successfully: $url"
            echo "pdf_url=$url" >> $GITHUB_ENV
          else
            echo "‚ùå Upload failed. Using fallback link..."
            echo "pdf_url=https://example.com" >> $GITHUB_ENV
          fi

      - name: Send professional email with inline PDF view
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          PDF_URL: ${{ env.pdf_url }}
        run: |
          python - <<'EOF'
          import os, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          recipients = [x.strip() for x in os.getenv("EMAIL_TO", "").split(",") if x.strip()]
          pdf_url = os.getenv("PDF_URL")

          msg = MIMEMultipart("alternative")
          msg["From"] = f"Maitexa Technologies <{sender}>"
          msg["To"] = ", ".join(recipients)
          msg["Subject"] = f"üåü Exciting Career Opportunities ‚Äì {datetime.now().strftime('%d %b %Y')}"

          html_content = f"""
          <html>
          <body style="font-family: Arial, sans-serif; font-size:15px; color:#222; line-height:1.6;">
              <p>Dear Team,</p>

              <p>We are thrilled to inform you that <strong>new and exciting career opportunities</strong> 
              are now open for talented individuals like you.</p>

              <p>At <strong>Maitexa Technologies</strong>, we believe that dreams are the starting point of every great success story. 
              This is your chance to chase your dreams and build a rewarding career with us.</p>

              <p>‚ú® <strong>Explore the latest openings</strong> and find the role that best fits your passion and skills.</p>

              <div style="text-align: center; margin-top: 20px;">
                  <a href="{pdf_url}" target="_blank"
                     style="display:inline-block; width:250px; background-color:#007A33; color:#fff; 
                     padding:12px 20px; text-decoration:none; border-radius:6px; font-weight:bold; margin:5px;">
                     üëÄ View Current Openings
                  </a><br>
                  <a href="{pdf_url}" download
                     style="display:inline-block; width:250px; background-color:#007A33; color:#fff; 
                     padding:12px 20px; text-decoration:none; border-radius:6px; font-weight:bold; margin:5px;">
                     ‚¨áÔ∏è Download Brochure (PDF)
                  </a>
              </div>

              <p style="margin-top: 20px;">
              Take a moment to look through the opportunities and apply for the position that aligns with your goals.<br>
              Your next big move could start today!
              </p>

              <p>We wish you all the best in your career journey. Let‚Äôs build a brighter future together!</p>

              <p style="margin-top:20px;">Warm regards,<br>
              <strong style="color:#007A33;">Maitexa Technologies Pvt Ltd</strong><br>
              Kadannamanna, Malappuram, Kerala ‚Äì 679324<br>
              <a href='mailto:contact@maitexa.com'>contact@maitexa.com</a> |
              <a href='https://www.maitexa.com'>www.maitexa.com</a>
              </p>

              <p style="font-size:12px; color:#666;">‚Äî Generated automatically by Maitexa Job Tracker ¬© 2025</p>
          </body>
          </html>
          """

          msg.attach(MIMEText(html_content, "html"))

          try:
              with smtplib.SMTP("smtp.gmail.com", 587) as server:
                  server.starttls()
                  server.login(sender, password)
                  server.send_message(msg)
              print(f"‚úÖ Email sent successfully with PDF link: {pdf_url}")
          except Exception as e:
              print(f"‚ùå Email send failed: {e}")
          EOF
