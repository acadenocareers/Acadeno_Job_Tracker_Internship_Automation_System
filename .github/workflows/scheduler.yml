name: Kerala IT Park Job Scraper Automation

on:
  schedule:
    # ‚è∞ Runs at 8:00 AM, 4:20 PM, and 9:00 PM IST
    - cron: '30 2,15 * * *'   # 8:00 AM & 9:00 PM IST
    - cron: '50 10 * * *'     # 4:20 PM IST
  workflow_dispatch:  # manual trigger option

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests beautifulsoup4 reportlab webdriver-manager

      # 4Ô∏è‚É£ Run your scraper (this generates a new PDF)
      - name: Run Maitexa job scraper
        run: python app.py

      # 5Ô∏è‚É£ Upload the generated PDF as artifact (optional ‚Äî for backup)
      - name: Upload PDF Report
        uses: actions/upload-artifact@v4
        with:
          name: Maitexa_Job_Brochure
          path: Maitexa_Green_Adjusted_Brochure.pdf

      # 6Ô∏è‚É£ Email the newly generated PDF
      - name: Send email with latest brochure
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          python - <<'EOF'
          import os, smtplib
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email import encoders

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          recipients = [x.strip() for x in os.getenv("EMAIL_TO", "").split(",") if x.strip()]

          msg = MIMEMultipart()
          msg['From'] = sender
          msg['To'] = ", ".join(recipients)
          msg['Subject'] = "üìÑ Maitexa Kerala IT Jobs ‚Äì Daily Brochure"
          msg.attach(MIMEText(
              "Dear Team,\n\nAttached is the latest Maitexa Kerala IT Parks job brochure with fresh openings.\n\n"
              "Regards,\nMaitexa Technologies\n", 
              'plain'
          ))

          attached = False
          pdf_file = "Maitexa_Green_Adjusted_Brochure.pdf"
          if os.path.exists(pdf_file):
              with open(pdf_file, 'rb') as f:
                  part = MIMEBase('application', 'pdf')
                  part.set_payload(f.read())
              encoders.encode_base64(part)
              part.add_header('Content-Disposition', f'attachment; filename="{pdf_file}"')
              msg.attach(part)
              attached = True

          if not attached:
              msg.attach(MIMEText("‚ö†Ô∏è PDF not found. The scraper may have failed to generate the file.", 'plain'))

          with smtplib.SMTP('smtp.gmail.com', 587) as server:
              server.starttls()
              server.login(sender, password)
              server.send_message(msg)

          print("‚úÖ Email with latest Maitexa brochure sent successfully!")
          EOF
